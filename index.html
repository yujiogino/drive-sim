<!DOCTYPE html>
<html>
<head>
  <title>Google Maps Drive Simulation</title>
  <style>
    html, body {
      margin: 0;
      height: 100%;
      overflow: hidden;
      font-family: sans-serif;
    }
    #container {
      display: flex;
      height: calc(100% - 60px);
    }
    #street-view, #map {
      flex: 1;
    }
    #controls {
      height: 60px;
      padding: 10px;
      background: #eee;
      display: flex;
      align-items: center;
      justify-content: space-around;
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="street-view"></div>
    <div id="map"></div>
  </div>
  <div id="controls">
    <button onclick="startDrive()">Start</button>
    <button onclick="stopDrive()">Stop</button>
    Speed:
    <input type="range" min="500" max="3000" value="1500" id="speedRange">
  </div>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAW393MmX87bvvVLhV1OToI1HybHaefF24&callback=initMap" async defer></script>
  <script>
    let map, panorama, interval, currentIndex = 0;
    let speed = 1500;

    const route = [
      { lat: 40.7128, lng: -74.0060 }, // New York
      { lat: 39.9526, lng: -75.1652 }, // Philadelphia
      { lat: 39.2904, lng: -76.6122 }, // Baltimore
      { lat: 38.9072, lng: -77.0369 }, // Washington DC
      { lat: 36.8508, lng: -76.2859 }, // Norfolk
      { lat: 35.2271, lng: -80.8431 }, // Charlotte
      { lat: 33.7488, lng: -84.3877 }, // Atlanta
      { lat: 30.3322, lng: -81.6557 }, // Jacksonville
      { lat: 27.9506, lng: -82.4572 }, // Tampa
      { lat: 25.7617, lng: -80.1918 }  // Miami
    ];

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: route[0],
        zoom: 7
      });

      panorama = new google.maps.StreetViewPanorama(
        document.getElementById("street-view"), {
          position: route[0],
          pov: { heading: 0, pitch: 0 },
          visible: true
        }
      );

      map.setStreetView(panorama);

      // 経路線を地図上に描画
      new google.maps.Polyline({
        path: route,
        geodesic: true,
        strokeColor: "#FF0000",
        strokeOpacity: 1.0,
        strokeWeight: 4,
        map: map
      });
    }

    function startDrive() {
      stopDrive(); // 前の interval を止める
      speed = document.getElementById("speedRange").value;

      interval = setInterval(() => {
        if (currentIndex >= route.length - 1) {
          stopDrive();
          return;
        }

        const current = route[currentIndex];
        const next = route[currentIndex + 1];

        const heading = google.maps.geometry.spherical.computeHeading(
          new google.maps.LatLng(current.lat, current.lng),
          new google.maps.LatLng(next.lat, next.lng)
        );

        panorama.setPosition(current);
        panorama.setPov({ heading: heading, pitch: 0 });

        map.panTo(current);
        currentIndex++;
      }, speed);
    }

    function moveToNextPoint() {
    if (!isPlaying || currentIndex >= route.length - 1) return;

     const point = route[currentIndex];
     const nextPoint = route[currentIndex + 1];
     const heading = google.maps.geometry.spherical.computeHeading(point, nextPoint);

  // ストリートビューのある地点を探す
  streetViewService.getPanorama(
    {
      location: point,
      radius: 50 // 半径50m以内で探索
    },
    (data, status) => {
      if (status === google.maps.StreetViewStatus.OK) {
        streetView.setPano(data.location.pano);
        streetView.setPov({ heading: heading, pitch: 0 });
        streetView.setVisible(true);

        streetViewMarker.setPosition(data.location.latLng);
        map.panTo(data.location.latLng);
      } else {
        console.warn("ストリートビューが見つかりません:", point);
        // ストリートビューが無ければマーカーのみ移動して続行
        streetView.setVisible(false);
        streetViewMarker.setPosition(point);
        map.panTo(point);
      }
    }
  );

  currentIndex++;
  if (isPlaying) {
    setTimeout(moveToNextPoint, speed);
  }
}






    function stopDrive() {
      clearInterval(interval);
    }

    document.getElementById("speedRange").addEventListener("input", e => {
      speed = e.target.value;
      if (interval) {
        startDrive(); // 再スタートして速度変更反映
      }
    });
  </script>
</body>
</html>
