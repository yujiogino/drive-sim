<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Google Maps ドライブシミュレーター</title>
    <style>
      body {
        margin: 0;
        font-family: sans-serif;
      }
      #container {
        display: flex;
        height: 90vh;
      }
      #streetview, #map {
        flex: 1;
      }
      #controls {
        height: 10vh;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 20px;
        background: #eee;
        padding: 10px;
      }
    </style>
  </head>
  <body>
    <div id="container">
      <div id="streetview"></div>
      <div id="map"></div>
    </div>
    <div id="controls">
      <button id="start">スタート</button>
      <button id="stop">ストップ</button>
      速度：<input type="range" id="speed" min="1" max="10" value="5">
    </div>

    <script>
      let map, streetView, directionsService, directionsRenderer;
      let stepIndex = 0;
      let path = [];
      let interval;

      function initMap() {
        const start = { lat: 40.7128, lng: -74.0060 }; // ニューヨーク

        map = new google.maps.Map(document.getElementById("map"), {
          center: start,
          zoom: 6,
        });

        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers: true });
        directionsRenderer.setMap(map);

        streetView = new google.maps.StreetViewPanorama(
          document.getElementById("streetview"), {
            position: start,
            pov: { heading: 0, pitch: 0 },
            visible: true,
          }
        );
        map.setStreetView(streetView);

        directionsService.route(
          {
            origin: start,
            destination: { lat: 25.7617, lng: -80.1918 }, // マイアミ
            travelMode: google.maps.TravelMode.DRIVING,
          },
          (result, status) => {
            if (status === "OK") {
              directionsRenderer.setDirections(result);
              const route = result.routes[0].legs[0].steps;
              path = route.flatMap((step) => step.path);
            }
          }
        );

        document.getElementById("start").addEventListener("click", startDrive);
        document.getElementById("stop").addEventListener("click", stopDrive);
      }

      function startDrive() {
        if (interval) clearInterval(interval);
        const speed = 1100 - document.getElementById("speed").value * 100;
        interval = setInterval(() => {
          if (stepIndex >= path.length) {
            clearInterval(interval);
            return;
          }
          const location = path[stepIndex];
          const next = path[stepIndex + 1];

          streetView.setPosition(location);

          if (next) {
            const heading = google.maps.geometry.spherical.computeHeading(location, next);
            streetView.setPov({ heading, pitch: 0 });
          }

          map.panTo(location);
          stepIndex++;
        }, speed);
      }

      function stopDrive() {
        clearInterval(interval);
      }
    </script>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAW393MmX87bvvVLhV1OToI1HybHaefF24&libraries=geometry&callback=initMap" async defer></script>
  </body>
</html>
